schema: '2.0'
stages:
  make_dataset:
    cmd: poetry run python src/make_dataset.py data/train.parquet
    deps:
    - path: src/make_dataset.py
      hash: md5
      md5: c67a625ae978784b517fadd9470ae53e
      size: 1919
    outs:
    - path: data/train.parquet
      hash: md5
      md5: 53361d2369e0a6f49667d3876258c691
      size: 12022017
  format_dataset:
    cmd: poetry run python src/format_dataset.py data/train.parquet data/formatted_dataset.parquet
      --limit=100
    deps:
    - path: data/train.parquet
      hash: md5
      md5: 53361d2369e0a6f49667d3876258c691
      size: 12022017
    - path: src/format_dataset.py
      hash: md5
      md5: f3e7ebca2614759ebf5bda8b67ebb555
      size: 1825
    outs:
    - path: data/formatted_dataset.parquet
      hash: md5
      md5: d83c9fa53ca3765a7ad6b9f5c48dfe59
      size: 382072
  embed_sentences:
    cmd: poetry run python src/embed_sentences.py data/formatted_dataset.parquet data/embeddings.parquet
      --dimension=384 --model_name=intfloat/multilingual-e5-small
    deps:
    - path: data/formatted_dataset.parquet
      hash: md5
      md5: d83c9fa53ca3765a7ad6b9f5c48dfe59
      size: 382072
    - path: src/embed_sentences.py
      hash: md5
      md5: 5de3e9fa1cf1657daf5bce71c84cab5d
      size: 2197
    - path: src/embedding/embedding.py
      hash: md5
      md5: d2516a18d3ee710693665fa8b78a2e65
      size: 3246
    outs:
    - path: data/embeddings.parquet
      hash: md5
      md5: 3c0988c6eb2450da5aa9fdbae9395363
      size: 613280
  generate_user_profiles:
    cmd: poetry run python -m src.batch_processing.generate_users --num_users=25 --categories="technology,sports,music,art"
      data/users_with_sentences.parquet
    deps:
    - path: src/batch_processing/generate_users.py
      hash: md5
      md5: 7d66976bf9ee0ba305f62344281cf4b8
      size: 2932
    outs:
    - path: data/users_with_sentences.parquet
      hash: md5
      md5: d83bd01bb20215debd0b423927466f06
      size: 12834
  generate_user_history:
    cmd: poetry run python src/generate_history.py data/formatted_dataset.parquet
      data/user_profiles.parquet data/user_history.parquet
    deps:
    - path: data/formatted_dataset.parquet
      hash: md5
      md5: d83c9fa53ca3765a7ad6b9f5c48dfe59
      size: 382072
    - path: data/user_profiles.parquet
      hash: md5
      md5: 24573b5b3b39b3c32a949a6edde3f5cf
      size: 9104
    - path: src/generate_history.py
      hash: md5
      md5: 7d13f866aaf8d3a97ca057e3812bbc87
      size: 1680
    outs:
    - path: data/user_history.parquet
      hash: md5
      md5: 9058296124d4911436c02e96d8859cff
      size: 9122
  make_articles:
    cmd: poetry run python -m src.batch_processing.make_dataset data/train.parquet
    deps:
    - path: src/batch_processing/make_dataset.py
      hash: md5
      md5: 64034da9936a628afe6f2ffb9164d416
      size: 2005
    outs:
    - path: data/train.parquet
      hash: md5
      md5: d1a625111c1e7a071cf6e1e4dba0e96e
      size: 12013185
  format_articles:
    cmd: poetry run python -m src.batch_processing.format_dataset data/train.parquet
      data/formatted_dataset.parquet --limit=50
    deps:
    - path: data/train.parquet
      hash: md5
      md5: d1a625111c1e7a071cf6e1e4dba0e96e
      size: 12013185
    - path: src/batch_processing/format_dataset.py
      hash: md5
      md5: adc72400124e4c3fb41d79e60446cf16
      size: 1734
    outs:
    - path: data/formatted_dataset.parquet
      hash: md5
      md5: 76209b5c0234ef35d1852bbb15fe17f8
      size: 236578
  embed_articles:
    cmd: poetry run python src/batch_processing/embed_sentences.py data/formatted_dataset.parquet
      data/article_embeddings.parquet --dimension=384 --model_name=intfloat/multilingual-e5-small
    deps:
    - path: data/formatted_dataset.parquet
      hash: md5
      md5: 48807c63c1bee8eeda1d31d3ca3a8208
      size: 197153
    - path: src/batch_processing/embed_sentences.py
      hash: md5
      md5: 39cb86adaeb702b1901c95a65cba2646
      size: 2355
    - path: src/batch_processing/embedding.py
      hash: md5
      md5: 1d3ae2f3553d85d2da013a0ff03dca3d
      size: 3840
    outs:
    - path: data/article_embeddings.parquet
      hash: md5
      md5: 2cd7fb0bcc5e3171e635346d0224377a
      size: 310773
  generate_history:
    cmd: poetry run python src/batch_processing/generate_history.py data/article_embeddings.parquet
      data/user_embeddings.parquet data/user_history.parquet --max_views=10
    deps:
    - path: data/article_embeddings.parquet
      hash: md5
      md5: 2cd7fb0bcc5e3171e635346d0224377a
      size: 310773
    - path: data/user_embeddings.parquet
      hash: md5
      md5: 1942558f9776e29b2a895dcfddc59dbf
      size: 68324
    - path: src/batch_processing/generate_history.py
      hash: md5
      md5: b0e34968285073f1e533001ae799e4e9
      size: 2835
    outs:
    - path: data/user_history.parquet
      hash: md5
      md5: a20fb1c2a184ea8fe6e67e5dc8cf5e6f
      size: 286979
  embed_users:
    cmd: poetry run python -m src.batch_processing.embed_sentences data/users_with_sentences.parquet
      data/user_embeddings.parquet
    deps:
    - path: data/users_with_sentences.parquet
      hash: md5
      md5: d83bd01bb20215debd0b423927466f06
      size: 12834
    - path: src/batch_processing/embed_sentences.py
      hash: md5
      md5: bc18e3aee247532f6f924bcbbfdeb517
      size: 2381
    outs:
    - path: data/user_embeddings.parquet
      hash: md5
      md5: 40d68ab8b5104b694780b7f09bb468e8
      size: 68847
  load_to_elasticsearch:
    cmd: poetry run python src/load_to_elasticsearch.py --es_host=https://localhost:9200
      --index_name=user_sentences data/users_with_sentences.parquet
    deps:
    - path: data/users_with_sentences.parquet
      hash: md5
      md5: a5d42738fe1b211d744a03bd190970b3
      size: 7951
    - path: src/load_to_elasticsearch.py
      hash: md5
      md5: 2a7e7b41fc2e74ebbbd36335fe480355
      size: 1166
  load_articles_to_elasticsearch:
    cmd: poetry run python src/batch_processing/load_to_elasticsearch.py --es_host=https://localhost:9200
      --index_name=article_data data/article_translation.parquet && echo `date` >
      data/load_articles_timestamp.txt
    deps:
    - path: data/article_translation.parquet
      hash: md5
      md5: 0aac468be29fe80caec273a174d2f4b8
      size: 327875
    - path: src/batch_processing/load_to_elasticsearch.py
      hash: md5
      md5: 9ffc15d3f33d8b19124efc2724da5a0f
      size: 1938
    outs:
    - path: data/load_articles_timestamp.txt
      hash: md5
      md5: 7cfbe908a138f1d5693dae8bae21455a
      size: 43
  load_users_to_elasticsearch:
    cmd: poetry run python src/batch_processing/load_to_elasticsearch.py --es_host=https://localhost:9200
      --index_name=user_sentences data/user_translation.parquet && echo `date` > data/load_users_timestamp.txt
    deps:
    - path: data/user_translation.parquet
      hash: md5
      md5: a086ac2202b46d5b42a914f625c4e086
      size: 76565
    - path: src/batch_processing/load_to_elasticsearch.py
      hash: md5
      md5: 9ffc15d3f33d8b19124efc2724da5a0f
      size: 1938
    outs:
    - path: data/load_users_timestamp.txt
      hash: md5
      md5: 46ee1d3af5e6708f8071ad21e8b78299
      size: 43
  search_demo:
    cmd: poetry run python -m src.search_program && echo `date` > data/search_timestamp.txt
    deps:
    - path: data/load_articles_timestamp.txt
      hash: md5
      md5: 70009d7261941a121df420e511cc946e
      size: 43
    - path: data/load_users_timestamp.txt
      hash: md5
      md5: 74976b590ec95e94cbbd96baaa9513f4
      size: 43
    - path: src/embedding/embedding.py
      hash: md5
      md5: 1d3ae2f3553d85d2da013a0ff03dca3d
      size: 3840
    - path: src/search_program.py
      hash: md5
      md5: 59a0292f88364d529946878f91b5dde8
      size: 3140
    outs:
    - path: data/search_timestamp.txt
      hash: md5
      md5: 575b0a4d1a75b6f96c490be672dede3a
      size: 43
  learn_two_tower_model:
    cmd: poetry run python src/batch_processing/train_two_tower_model.py data/user_history.parquet
      models/two_tower_model.pth --epochs=20000 --patience=500
    deps:
    - path: data/user_history.parquet
      hash: md5
      md5: a20fb1c2a184ea8fe6e67e5dc8cf5e6f
      size: 286979
    - path: src/batch_processing/train_two_tower_model.py
      hash: md5
      md5: f3db7753144313ec0e16c4464de00b3c
      size: 2722
    - path: src/batch_processing/two_tower_model.py
      hash: md5
      md5: 85fd73adaba94ca351a3468ee8013ce3
      size: 1374
    outs:
    - path: models/two_tower_model.pth
      hash: md5
      md5: 19d9e3285f369ff1d8fb73da4ed5ba3c
      size: 464032
  use_elasticsearch:
    cmd: echo use elasticsearch && echo `date` > data/use_elasticsearch.txt
    deps:
    - path: data/load_articles_timestamp.txt
      hash: md5
      md5: 7cfbe908a138f1d5693dae8bae21455a
      size: 43
    - path: data/load_users_timestamp.txt
      hash: md5
      md5: 46ee1d3af5e6708f8071ad21e8b78299
      size: 43
    outs:
    - path: data/use_elasticsearch.txt
      hash: md5
      md5: 7cfbe908a138f1d5693dae8bae21455a
      size: 43
  make_user_translation:
    cmd: poetry run python src/batch_processing/make_user_translation.py data/user_embeddings.parquet
      data/user_translation.parquet models/two_tower_model.pth
    deps:
    - path: data/user_embeddings.parquet
      hash: md5
      md5: 1942558f9776e29b2a895dcfddc59dbf
      size: 68324
    - path: models/two_tower_model.pth
      hash: md5
      md5: 19d9e3285f369ff1d8fb73da4ed5ba3c
      size: 464032
    - path: src/batch_processing/make_user_translation.py
      hash: md5
      md5: 3389319cf16d68deb4200e100b6e420c
      size: 1541
    outs:
    - path: data/user_translation.parquet
      hash: md5
      md5: a086ac2202b46d5b42a914f625c4e086
      size: 76565
  make_article_translation:
    cmd: poetry run python src/batch_processing/make_article_translation.py data/article_embeddings.parquet
      data/article_translation.parquet models/two_tower_model.pth
    deps:
    - path: data/article_embeddings.parquet
      hash: md5
      md5: 2cd7fb0bcc5e3171e635346d0224377a
      size: 310773
    - path: models/two_tower_model.pth
      hash: md5
      md5: 19d9e3285f369ff1d8fb73da4ed5ba3c
      size: 464032
    - path: src/batch_processing/make_article_translation.py
      hash: md5
      md5: 4c5acb3965b79f7d9dfa330f6d88b915
      size: 1638
    outs:
    - path: data/article_translation.parquet
      hash: md5
      md5: 0aac468be29fe80caec273a174d2f4b8
      size: 327875
  make_items:
    cmd: poetry run python -m src.batch_processing.make_dataset data/train.parquet
    deps:
    - path: src/batch_processing/make_dataset.py
      hash: md5
      md5: 64034da9936a628afe6f2ffb9164d416
      size: 2005
    outs:
    - path: data/train.parquet
      hash: md5
      md5: d1a625111c1e7a071cf6e1e4dba0e96e
      size: 12013185
  format_items:
    cmd: poetry run python -m src.batch_processing.format_dataset data/train.parquet
      data/formatted_dataset.parquet --limit=50
    deps:
    - path: data/train.parquet
      hash: md5
      md5: d1a625111c1e7a071cf6e1e4dba0e96e
      size: 12013185
    - path: src/batch_processing/format_dataset.py
      hash: md5
      md5: adc72400124e4c3fb41d79e60446cf16
      size: 1734
    outs:
    - path: data/formatted_dataset.parquet
      hash: md5
      md5: 76209b5c0234ef35d1852bbb15fe17f8
      size: 236578
  embed_items:
    cmd: poetry run python -m src.batch_processing.embed_sentences data/formatted_dataset.parquet
      data/item_embeddings.parquet --dimension=384 --model_name=intfloat/multilingual-e5-small
    deps:
    - path: data/formatted_dataset.parquet
      hash: md5
      md5: 76209b5c0234ef35d1852bbb15fe17f8
      size: 236578
    - path: src/batch_processing/embed_sentences.py
      hash: md5
      md5: bc18e3aee247532f6f924bcbbfdeb517
      size: 2381
    - path: src/model/embedding.py
      hash: md5
      md5: 1d3ae2f3553d85d2da013a0ff03dca3d
      size: 3840
    outs:
    - path: data/item_embeddings.parquet
      hash: md5
      md5: b7cef9e463735b5f3eaf1a9c58a1c5bb
      size: 350190
