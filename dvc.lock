schema: '2.0'
stages:
  make_dataset:
    cmd: poetry run python src/make_dataset.py data/train.parquet
    deps:
    - path: src/make_dataset.py
      hash: md5
      md5: c67a625ae978784b517fadd9470ae53e
      size: 1919
    outs:
    - path: data/train.parquet
      hash: md5
      md5: 53361d2369e0a6f49667d3876258c691
      size: 12022017
  format_dataset:
    cmd: poetry run python src/format_dataset.py data/train.parquet data/formatted_dataset.parquet
      --limit=100
    deps:
    - path: data/train.parquet
      hash: md5
      md5: 53361d2369e0a6f49667d3876258c691
      size: 12022017
    - path: src/format_dataset.py
      hash: md5
      md5: f3e7ebca2614759ebf5bda8b67ebb555
      size: 1825
    outs:
    - path: data/formatted_dataset.parquet
      hash: md5
      md5: d83c9fa53ca3765a7ad6b9f5c48dfe59
      size: 382072
  embed_sentences:
    cmd: poetry run python src/embed_sentences.py data/formatted_dataset.parquet data/embeddings.parquet
      --dimension=384 --model_name=intfloat/multilingual-e5-small
    deps:
    - path: data/formatted_dataset.parquet
      hash: md5
      md5: d83c9fa53ca3765a7ad6b9f5c48dfe59
      size: 382072
    - path: src/embed_sentences.py
      hash: md5
      md5: 5de3e9fa1cf1657daf5bce71c84cab5d
      size: 2197
    - path: src/embedding/embedding.py
      hash: md5
      md5: d2516a18d3ee710693665fa8b78a2e65
      size: 3246
    outs:
    - path: data/embeddings.parquet
      hash: md5
      md5: 3c0988c6eb2450da5aa9fdbae9395363
      size: 613280
  generate_user_profiles:
    cmd: poetry run python src/generate_users.py --num_users=25 --categories="technology,sports,music,art"
      data/users_with_sentences.parquet
    deps:
    - path: src/generate_users.py
      hash: md5
      md5: 7d66976bf9ee0ba305f62344281cf4b8
      size: 2932
    params:
      params.yaml:
        num_users: 25
    outs:
    - path: data/users_with_sentences.parquet
      hash: md5
      md5: f70468e5eba8b3c32e219d9a7e022c6d
      size: 12669
  generate_user_history:
    cmd: poetry run python src/generate_history.py data/formatted_dataset.parquet
      data/user_profiles.parquet data/user_history.parquet
    deps:
    - path: data/formatted_dataset.parquet
      hash: md5
      md5: d83c9fa53ca3765a7ad6b9f5c48dfe59
      size: 382072
    - path: data/user_profiles.parquet
      hash: md5
      md5: 24573b5b3b39b3c32a949a6edde3f5cf
      size: 9104
    - path: src/generate_history.py
      hash: md5
      md5: 7d13f866aaf8d3a97ca057e3812bbc87
      size: 1680
    outs:
    - path: data/user_history.parquet
      hash: md5
      md5: 9058296124d4911436c02e96d8859cff
      size: 9122
  make_articles:
    cmd: poetry run python src/make_dataset.py data/train.parquet
    deps:
    - path: src/make_dataset.py
      hash: md5
      md5: c67a625ae978784b517fadd9470ae53e
      size: 1919
    outs:
    - path: data/train.parquet
      hash: md5
      md5: 53361d2369e0a6f49667d3876258c691
      size: 12022017
  format_articles:
    cmd: poetry run python src/format_dataset.py data/train.parquet data/formatted_dataset.parquet
      --limit=50
    deps:
    - path: data/train.parquet
      hash: md5
      md5: 53361d2369e0a6f49667d3876258c691
      size: 12022017
    - path: src/format_dataset.py
      hash: md5
      md5: adc72400124e4c3fb41d79e60446cf16
      size: 1734
    outs:
    - path: data/formatted_dataset.parquet
      hash: md5
      md5: f077683c3f92b21425373dcc66fd4c56
      size: 220900
  embed_articles:
    cmd: poetry run python src/embed_sentences.py data/formatted_dataset.parquet data/article_embeddings.parquet
      --dimension=384 --model_name=intfloat/multilingual-e5-small
    deps:
    - path: data/formatted_dataset.parquet
      hash: md5
      md5: f077683c3f92b21425373dcc66fd4c56
      size: 220900
    - path: src/embed_sentences.py
      hash: md5
      md5: 5de3e9fa1cf1657daf5bce71c84cab5d
      size: 2197
    - path: src/embedding/embedding.py
      hash: md5
      md5: 1d3ae2f3553d85d2da013a0ff03dca3d
      size: 3840
    outs:
    - path: data/article_embeddings.parquet
      hash: md5
      md5: 4429adb07b9899ff8eae7ee6a80c4931
      size: 334516
  generate_history:
    cmd: poetry run python src/generate_history.py data/formatted_dataset.parquet
      data/users_with_sentences.parquet data/user_history.parquet --max_views=10
    deps:
    - path: data/formatted_dataset.parquet
      hash: md5
      md5: f077683c3f92b21425373dcc66fd4c56
      size: 220900
    - path: data/users_with_sentences.parquet
      hash: md5
      md5: f70468e5eba8b3c32e219d9a7e022c6d
      size: 12669
    - path: src/generate_history.py
      hash: md5
      md5: 894154d23114b25d77999c8a8a96e7e0
      size: 1618
    outs:
    - path: data/user_history.parquet
      hash: md5
      md5: c6e36ea52e18d5970fe92a9521fb15d1
      size: 5937
  embed_users:
    cmd: poetry run python src/embed_sentences.py data/users_with_sentences.parquet
      data/user_embeddings.parquet
    deps:
    - path: data/users_with_sentences.parquet
      hash: md5
      md5: f70468e5eba8b3c32e219d9a7e022c6d
      size: 12669
    - path: src/embed_sentences.py
      hash: md5
      md5: 5de3e9fa1cf1657daf5bce71c84cab5d
      size: 2197
    outs:
    - path: data/user_embeddings.parquet
      hash: md5
      md5: 3803a5dc6124e90ed9789f280519f311
      size: 68678
  load_to_elasticsearch:
    cmd: poetry run python src/load_to_elasticsearch.py --es_host=https://localhost:9200
      --index_name=user_sentences data/users_with_sentences.parquet
    deps:
    - path: data/users_with_sentences.parquet
      hash: md5
      md5: a5d42738fe1b211d744a03bd190970b3
      size: 7951
    - path: src/load_to_elasticsearch.py
      hash: md5
      md5: 2a7e7b41fc2e74ebbbd36335fe480355
      size: 1166
  load_articles_to_elasticsearch:
    cmd: poetry run python src/load_to_elasticsearch.py --es_host=https://localhost:9200
      --index_name=article_data data/article_embeddings.parquet && echo `date` > data/load_articles_timestamp.txt
    deps:
    - path: data/article_embeddings.parquet
      hash: md5
      md5: 4429adb07b9899ff8eae7ee6a80c4931
      size: 334516
    - path: src/load_to_elasticsearch.py
      hash: md5
      md5: 6d43d66aeb9fef851f854c71ba97e537
      size: 1877
    outs:
    - path: data/load_articles_timestamp.txt
      hash: md5
      md5: 1ea29aa6675ab266e76f58cd309aa6c5
      size: 43
  load_users_to_elasticsearch:
    cmd: poetry run python src/load_to_elasticsearch.py --es_host=https://localhost:9200
      --index_name=user_sentences data/user_embeddings.parquet && echo `date` > data/load_users_timestamp.txt
    deps:
    - path: data/user_embeddings.parquet
      hash: md5
      md5: 3803a5dc6124e90ed9789f280519f311
      size: 68678
    - path: src/load_to_elasticsearch.py
      hash: md5
      md5: 6d43d66aeb9fef851f854c71ba97e537
      size: 1877
    outs:
    - path: data/load_users_timestamp.txt
      hash: md5
      md5: cd4df1d1e9942ff3981f1f341ab402c7
      size: 43
  search_demo:
    cmd: poetry run python -m src.search_program && echo `date` > data/search_timestamp.txt
    deps:
    - path: data/load_articles_timestamp.txt
      hash: md5
      md5: 1ea29aa6675ab266e76f58cd309aa6c5
      size: 43
    - path: data/load_users_timestamp.txt
      hash: md5
      md5: cd4df1d1e9942ff3981f1f341ab402c7
      size: 43
    - path: src/embedding/embedding.py
      hash: md5
      md5: 1d3ae2f3553d85d2da013a0ff03dca3d
      size: 3840
    - path: src/search_program.py
      hash: md5
      md5: 83689f63926df5c9f70862142d862cc0
      size: 2307
    outs:
    - path: data/search_timestamp.txt
      hash: md5
      md5: 7084e50d49dee0dd3c415e6048034396
      size: 43
